{% load static %}
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page_title|default:"IPæ± ç®¡ç†" }}</title>
    <link rel="stylesheet" type="text/css" href="{% static 'css/ip_poolstyle.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
    <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
    <nav class="top-nav">
        <div class="nav-logo">
            <h1>å‡¡çœ¼å·¥ä½œå°</h1>
        </div>
        <div class="nav-links">
            <a href="/" class="nav-item">é¦–é¡µ</a>
            <a href="{% url 'ip_pool' %}" class="nav-item active">IPæ± </a>
            <a href="javascript:void(0)" class="nav-item" onclick="openSettingsModal()">
                <i class="fas fa-cog"></i> è®¾ç½®
            </a>
            <a href="#" class="nav-item">å¸®åŠ©</a>
        </div>
    </nav>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
        <!-- å·¦ä¾§å·¥ä½œå° -->
        <div class="sidebar">
            <h2>å·¥ä½œå°</h2>
            <div class="menu-list">
                <a href="{% url 'ip_pool' %}" class="menu-item {% if active_menu == 'ip_pool_overview' %}active{% endif %}">
                    <span>IPæ± æ¦‚è§ˆ</span>
                </a>
                <a href="{% url 'ip_manage' %}" class="menu-item {% if active_menu == 'ip_manage' %}active{% endif %}">
                    <span>IPç®¡ç†</span>
                </a>
                <a href="{% url 'proxy_settings' %}" class="menu-item {% if active_menu == 'proxy_settings' %}active{% endif %}">
                    <span>ä»£ç†è®¾ç½®</span>
                </a>
                <a href="{% url 'monitoring' %}" class="menu-item {% if active_menu == 'monitoring' %}active{% endif %}">
                    <span>ç›‘æ§ç»Ÿè®¡</span>
                </a>
                <a href="{% url 'operation_log' %}" class="menu-item {% if active_menu == 'operation_log' %}active{% endif %}">
                    <span>æ“ä½œæ—¥å¿—</span>
                </a>
            </div>
        </div>

        <!-- å³ä¾§å†…å®¹åŒºåŸŸ -->
        <div class="content-area">
            <div class="content-header">
                <h2>{{ page_title|default:"IPæ± æ¦‚è§ˆ" }}</h2>
            </div>
            <div class="content-body">
                {% if active_menu == 'ip_pool_overview' %}
                    <!-- IPæ± æ¦‚è§ˆå†…å®¹ -->
                    <div class="stats-cards">
                        <div class="stat-card">
                            <h3>æ€»IPæ•°é‡</h3>
                            <p class="stat-number">{{ ip_stats.total }}</p>
                        </div>
                        <div class="stat-card">
                            <h3>æ´»è·ƒIP</h3>
                            <p class="stat-number">{{ ip_stats.active }}</p>
                        </div>
                        <div class="stat-card">
                            <h3>ä¸æ´»è·ƒIP</h3>
                            <p class="stat-number">{{ ip_stats.inactive }}</p>
                        </div>
                    </div>
                {% elif active_menu == 'ip_manage' %}
                    <!-- IPç®¡ç†è¡¨æ ¼ -->
                    <div class="table-container">
                        <div class="table-actions">
                            <button class="btn btn-primary">æ·»åŠ IP</button>
                            <button class="btn btn-secondary">æ‰¹é‡å¯¼å…¥</button>
                            <div class="search-box">
                                <input type="text" placeholder="æœç´¢IP...">
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>æœåŠ¡å™¨</th>
                                    <th>å»¶è¿Ÿms</th>
                                    <th>é€Ÿåº¦</th>
                                    <th>ä¸Šä¼ æ—¶é—´1</th>
                                    <th>ä¸Šä¼ æ—¶é—´2</th>
                                    <th>ç±»å‹</th>
                                    <th>å›½å®¶</th>
                                    <th>SSL</th>
                                    <th>CONN.</th>
                                    <th>æœ€è¿‘å·¥ä½œæ—¶é—´</th>
                                    <th>åˆ†æ•°</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ip in ip_list %}
                                <tr>
                                    <td>{{ ip.server }}</td>
                                    <td>{{ ip.delay }}</td>
                                    <td>{{ ip.speed }}</td>
                                    <td>{{ ip.upload_time1 }}</td>
                                    <td>{{ ip.upload_time2 }}</td>
                                    <td>{{ ip.type }}</td>
                                    <td>{{ ip.country }}</td>
                                    <td>{{ ip.ssl }}</td>
                                    <td>{{ ip.conn }}</td>
                                    <td>{{ ip.last_work_time }}</td>
                                    <td>{{ ip.score }}</td>
                                    <td>
                                        <button class="btn-icon" title="ç¼–è¾‘">âœï¸</button>
                                        <button class="btn-icon" title="åˆ é™¤">ğŸ—‘ï¸</button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <div class="pagination">
                            {% if ip_list.has_previous %}
                                <a href="?page=1" class="page-link first-page">é¦–é¡µ</a>
                                <a href="?page={{ ip_list.previous_page_number }}" class="page-link">ä¸Šä¸€é¡µ</a>
                            {% endif %}

                            <div class="current-page">
                                ç¬¬ {{ ip_list.number }} é¡µ / å…± {{ ip_list.paginator.num_pages }} é¡µ
                            </div>

                            {% if ip_list.has_next %}
                                <a href="?page={{ ip_list.next_page_number }}" class="page-link">ä¸‹ä¸€é¡µ</a>
                                <a href="?page={{ ip_list.paginator.num_pages }}" class="page-link last-page">æœ«é¡µ</a>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- åœ¨é¡µé¢åº•éƒ¨æ·»åŠ æ¨¡æ€æ¡† -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>IPæ± é…ç½®</h3>
                <span class="close" onclick="closeSettingsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="settingsForm" class="settings-form">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="crawler_interval">çˆ¬è™«é‡‡é›†é—´éš”ï¼ˆç§’ï¼‰</label>
                        <div class="input-with-unit">
                            <input type="number" 
                                   id="crawler_interval" 
                                   name="crawler_interval" 
                                   value="{{ proxy_settings.crawler_interval }}"
                                   min="60"
                                   required>
                            <span class="unit">ç§’</span>
                        </div>
                        <small class="form-text">çˆ¬è™«å¤šä¹…è¿è¡Œä¸€æ¬¡ï¼ˆæœ€å°60ç§’ï¼‰</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="score_interval">IPè¯„åˆ†é—´éš”ï¼ˆç§’ï¼‰</label>
                        <div class="input-with-unit">
                            <input type="number" 
                                   id="score_interval" 
                                   name="score_interval" 
                                   value="{{ proxy_settings.score_interval }}"
                                   min="60"
                                   required>
                            <span class="unit">ç§’</span>
                        </div>
                        <small class="form-text">IPæ± ä¸­çš„ä»£ç†å¤šä¹…è¯„åˆ†ä¸€æ¬¡ï¼ˆæœ€å°60ç§’ï¼‰</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="min_score">æœ€ä½åˆ†æ•°é˜ˆå€¼</label>
                        <div class="input-with-unit">
                            <input type="number" 
                                   id="min_score" 
                                   name="min_score" 
                                   value="{{ proxy_settings.min_score }}"
                                   min="0"
                                   max="100"
                                   required>
                            <span class="unit">åˆ†</span>
                        </div>
                        <small class="form-text">ä½äºæ­¤åˆ†æ•°çš„IPå°†è¢«åˆ é™¤ï¼ˆ0-100ï¼‰</small>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">ä¿å­˜è®¾ç½®</button>
                        <button type="button" class="btn btn-secondary" onclick="closeSettingsModal()">å–æ¶ˆ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- åœ¨é¡µé¢åº•éƒ¨æ·»åŠ è„šæœ¬å¼•ç”¨ -->
    {% block scripts %}
    <script src="{% static 'js/ip_pool.js' %}"></script>
    <script>
    // ç¡®ä¿DOMåŠ è½½å®Œæˆåå†ç»‘å®šäº‹ä»¶
    document.addEventListener('DOMContentLoaded', function() {
        // æ¨¡æ€æ¡†æ§åˆ¶
        window.openSettingsModal = function() {
            document.getElementById('settingsModal').style.display = 'block';
            fetchCurrentSettings();
        };

        window.closeSettingsModal = function() {
            document.getElementById('settingsModal').style.display = 'none';
        };

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('settingsModal');
            if (event.target == modal) {
                closeSettingsModal();
            }
        };

        // è¡¨å•æäº¤å¤„ç†
        const settingsForm = document.getElementById('settingsForm');
        if (settingsForm) {
            settingsForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                
                try {
                    const response = await fetch('/proxy/settings/', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('è®¾ç½®å·²æ›´æ–°');
                        closeSettingsModal();
                    } else {
                        alert(result.error || 'æ›´æ–°å¤±è´¥');
                    }
                } catch (error) {
                    alert('ä¿å­˜è®¾ç½®æ—¶å‘ç”Ÿé”™è¯¯');
                }
            });
        }
    });
    </script>
    {% endblock %}
</body>
</html>

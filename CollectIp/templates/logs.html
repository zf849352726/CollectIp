{% extends 'index.html' %}
{% load static %}

{% block extra_css %}
<style>
    .logs-container {
        padding: 20px;
        background-color: #f8f9fa;
        min-height: calc(100vh - 60px);
    }
    
    .logs-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .logs-title {
        font-size: 24px;
        font-weight: 600;
        color: #2c3e50;
    }
    
    .logs-filter {
        display: flex;
        gap: 15px;
        align-items: center;
    }
    
    .logs-cards {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .log-card {
        background-color: white;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s;
    }
    
    .log-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .log-card h3 {
        font-size: 18px;
        color: #333;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
    }
    
    .log-card h3 .badge {
        margin-left: 10px;
        font-size: 12px;
    }
    
    .log-card p {
        color: #666;
        margin-bottom: 15px;
        font-size: 14px;
    }
    
    .log-card .log-size {
        font-size: 12px;
        color: #999;
    }
    
    .log-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
    }
    
    .log-content {
        background-color: #1e1e1e;
        color: #d4d4d4;
        border-radius: 5px;
        padding: 15px;
        font-family: monospace;
        max-height: 500px;
        overflow-y: auto;
        margin-top: 20px;
        white-space: pre-wrap;
        word-break: break-all;
    }
    
    .log-content .log-line:hover {
        background-color: #2a2a2a;
    }
    
    .log-type {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 3px;
        margin-right: 10px;
        font-size: 12px;
    }
    
    .log-info {
        background-color: #007bff;
        color: white;
    }
    
    .log-error {
        background-color: #dc3545;
        color: white;
    }
    
    .log-warning {
        background-color: #ffc107;
        color: black;
    }
    
    .log-debug {
        background-color: #6c757d;
        color: white;
    }
    
    .pagination {
        margin-top: 20px;
        display: flex;
        justify-content: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="logs-container">
    <div class="logs-header">
        <h2 class="logs-title">系统日志查询</h2>
        <div class="logs-filter">
            <select class="form-select" id="logTypeFilter">
                <option value="all">所有日志</option>
                <option value="django">Django系统日志</option>
                <option value="crawler">爬虫日志</option>
                <option value="spider">爬虫进程日志</option>
                <option value="scheduler">调度器日志</option>
                <option value="douban">豆瓣采集日志</option>
            </select>
            <button class="btn btn-primary" id="refreshLogs">刷新</button>
        </div>
    </div>
    
    <div class="logs-cards">
        {% for log in log_files %}
        <div class="log-card" data-type="{{ log.type }}">
            <h3>
                {{ log.name }}
                {% if log.has_error %}
                <span class="badge bg-danger">有错误</span>
                {% endif %}
            </h3>
            <p>{{ log.description }}</p>
            <div class="log-size">文件大小: {{ log.size }}</div>
            <div class="log-actions">
                <span>最后更新: {{ log.last_modified }}</span>
                <button class="btn btn-sm btn-primary view-log-btn" data-log-path="{{ log.path }}">查看日志</button>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- 日志查看模态框 -->
    <div class="modal fade" id="logViewModal" tabindex="-1" aria-labelledby="logViewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logViewModalLabel">日志内容</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="autoScroll" checked>
                            <label class="form-check-label" for="autoScroll">
                                自动滚动到底部
                            </label>
                        </div>
                        <div class="input-group" style="max-width: 300px;">
                            <input type="text" class="form-control" placeholder="搜索日志..." id="logSearch">
                            <button class="btn btn-outline-secondary" type="button" id="searchLogBtn">搜索</button>
                        </div>
                    </div>
                    <div class="log-content" id="logContent">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2">加载日志内容中...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="downloadLogBtn">下载日志</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 日志类型过滤器
    const logTypeFilter = document.getElementById('logTypeFilter');
    logTypeFilter.addEventListener('change', filterLogs);
    
    // 刷新按钮
    const refreshBtn = document.getElementById('refreshLogs');
    refreshBtn.addEventListener('click', function() {
        window.location.reload();
    });
    
    // 查看日志按钮
    const viewLogBtns = document.querySelectorAll('.view-log-btn');
    viewLogBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const logPath = this.getAttribute('data-log-path');
            openLogModal(logPath);
        });
    });
    
    // 自动滚动到底部
    const autoScrollCheckbox = document.getElementById('autoScroll');
    
    // 搜索日志内容
    const searchLogBtn = document.getElementById('searchLogBtn');
    const logSearch = document.getElementById('logSearch');
    
    searchLogBtn.addEventListener('click', searchInLog);
    logSearch.addEventListener('keyup', function(event) {
        if (event.key === 'Enter') {
            searchInLog();
        }
    });
    
    // 下载日志按钮
    const downloadLogBtn = document.getElementById('downloadLogBtn');
    let currentLogPath = '';
    
    downloadLogBtn.addEventListener('click', function() {
        if (currentLogPath) {
            window.location.href = `/api/logs/download/?path=${encodeURIComponent(currentLogPath)}`;
        }
    });
    
    // 过滤日志卡片
    function filterLogs() {
        const selectedType = logTypeFilter.value;
        const logCards = document.querySelectorAll('.log-card');
        
        logCards.forEach(card => {
            const cardType = card.getAttribute('data-type');
            if (selectedType === 'all' || cardType === selectedType) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        });
    }
    
    // 打开日志查看模态框
    function openLogModal(logPath) {
        currentLogPath = logPath;
        const logContent = document.getElementById('logContent');
        
        // 显示加载中
        logContent.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2">加载日志内容中...</p>
            </div>
        `;
        
        // 显示模态框
        const modal = new bootstrap.Modal(document.getElementById('logViewModal'));
        modal.show();
        
        // 获取日志内容
        fetch(`/api/logs/content/?path=${encodeURIComponent(logPath)}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    let logHTML = '';
                    const lines = data.content.split('\n');
                    
                    lines.forEach((line, index) => {
                        // 添加日志类型样式
                        let lineClass = '';
                        if (line.includes('ERROR') || line.includes('CRITICAL')) {
                            lineClass = 'text-danger';
                        } else if (line.includes('WARNING')) {
                            lineClass = 'text-warning';
                        } else if (line.includes('INFO')) {
                            lineClass = 'text-info';
                        } else if (line.includes('DEBUG')) {
                            lineClass = 'text-secondary';
                        }
                        
                        logHTML += `<div class="log-line ${lineClass}">${line}</div>`;
                    });
                    
                    logContent.innerHTML = logHTML;
                    
                    // 如果选中了自动滚动，则滚动到底部
                    if (autoScrollCheckbox.checked) {
                        logContent.scrollTop = logContent.scrollHeight;
                    }
                } else {
                    logContent.innerHTML = `<div class="text-danger p-3">加载日志失败: ${data.message}</div>`;
                }
            })
            .catch(error => {
                logContent.innerHTML = `<div class="text-danger p-3">加载日志错误: ${error.message}</div>`;
            });
    }
    
    // 搜索日志内容
    function searchInLog() {
        const searchTerm = logSearch.value.toLowerCase().trim();
        if (!searchTerm) return;
        
        const logLines = document.querySelectorAll('.log-line');
        let firstMatch = null;
        
        logLines.forEach(line => {
            line.classList.remove('bg-light');
            if (line.textContent.toLowerCase().includes(searchTerm)) {
                line.classList.add('bg-light');
                if (!firstMatch) {
                    firstMatch = line;
                }
            }
        });
        
        if (firstMatch) {
            firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
});
</script>
{% endblock %} 